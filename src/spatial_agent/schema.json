{
  "schema_version": "0.1",
  "workflow_id": "wf_0001",
  "title": "Transit 500m renewal parcels selection",
  "user_request": "Evaluate residential parcels within 500 meters of metro stations that are suitable for renewal.",
  "scope": {
    "crs_requirement": {
      "type": "projected",
      "reason": "A projected coordinate system is required when calculating distances."
    }
  },
  "inputs": [
    {
      "name": "metro_stations",
      "role": "source",
      "geometry_type": "point",
      "required_fields": ["station_id"],
      "optional_fields": ["station_name", "line"],
      "data_requirements": {
        "must_be_projected": true,
        "must_have_valid_geometry": true
      }
    },
    {
      "name": "buildings",
      "role": "source",
      "geometry_type": "polygon",
      "required_fields": ["year_built", "story"],
      "data_requirements": {
        "must_be_projected": true,
        "must_have_valid_geometry": true
      }
    },
    {
      "name": "parcels",
      "role": "target",
      "geometry_type": "polygon",
      "required_fields": ["parcel_id", "land_use"],
      "optional_fields": ["year_built", "floor_area_ratio", "redevelopment_score"],
      "data_requirements": {
        "must_be_projected": true,
        "must_have_valid_geometry": true
      }
    }
  ],
  "assumptions": [
    {
      "id": "A1",
      "type": "method",
      "statement": "500m service area is approximated using a Euclidean distance buffer.",
      "risk": "Might ignore real walking distance.",
      "mitigation": "A network-based service area can be used as an alternative."
    }
  ],
  "steps": [
    {
      "step_id": "S1",
      "tool": "buffer",
      "purpose": "Generate stations' impact zone of 500m radius.",
      "inputs": {
        "source_layer": "metro_stations"
      },
      "parameters": {
        "distance": {
          "value": 500,
          "unit": "meters"
        },
        "dissolve": true
      },
      "outputs": {
        "output_layer": "stations_buffer_500m",
        "geometry_type": "polygon"
      },
      "rationale": "Define the area surrounding the metro stations as the impact zone.",
      "preconditions": [
        {
          "type": "crs_projected",
          "layers": ["metro_stations"],
          "required": true
        }
      ],
      "postconditions": [
        {
          "type": "geometry_validity_check",
          "severity": "warning"
        }
      ]
    },
    {
      "step_id": "S2",
      "tool": "calculate_field",
      "purpose": "calculate buildings base area",
      "inputs": {
        "source_layer": "buildings"
      },
      "parameters": {
        "target_field": "base_area",
        "expression_type": "python",
        "expression": "shape_area(!geometry!)",
        "creates_field_if_missing": true
      },
      "outputs": {
        "output_layer": "buildings_base_area",
        "geometry_type": "polygon"
      },
      "rationale": "Calculate the projection area of the building, which serves as the basis for calculating the floor area.",
      "preconditions": [
        {
          "type": "crs_projected",
          "layers": ["buildings"],
          "required": true
        }
      ],
      "postconditions": [
        {
          "type": "field_populated_rate",
          "layer": "buildings_base_area",
          "field": "base_area",
          "min_non_null_ratio": 0.95,
          "severity": "warning"
        }
      ]
    },
    {
      "step_id": "S3",
      "tool": "calculate_field",
      "purpose": "calculate building gross floor area",
      "inputs": {
        "source_layer": "buildings_base_area"
      },
      "parameters": {
        "target_field": "building_area",
        "expression_type": "python",
        "expression": "!base_area! * !story!",
        "creates_field_if_missing": true
      },
      "outputs": {
        "output_layer": "buildings_gfa",
        "geometry_type": "polygon"
      },
      "rationale": "Multiply the base area by the number of story to estimate the total floor area of a single building.",
      "preconditions": [
        {
          "type": "fields_exist",
          "layer": "buildings_base_area",
          "fields": ["base_area", "story"],
          "required": true
        }
      ],
      "postconditions": [
        {
          "type": "field_populated_rate",
          "layer": "buildings_gfa",
          "field": "building_area",
          "min_non_null_ratio": 0.95,
          "severity": "warning"
        }
      ]
    },
    {
      "step_id": "S4",
      "tool": "calculate_field",
      "purpose": "calculate parcel area",
      "inputs": {
        "source_layer": "parcels"
      },
      "parameters": {
        "target_field": "parcel_area",
        "expression_type": "python",
        "expression": "shape_area(!geometry!)",
        "creates_field_if_missing": true
      },
      "outputs": {
        "output_layer": "parcels_area",
        "geometry_type": "polygon"
      },
      "rationale": "Prepare the land area for calculating the floor area ratio.",
      "preconditions": [
        {
          "type": "crs_projected",
          "layers": ["parcels"],
          "required": true
        }
      ],
      "postconditions": [
        {
          "type": "field_populated_rate",
          "layer": "parcels_area",
          "field": "parcel_area",
          "min_non_null_ratio": 0.95,
          "severity": "warning"
        }
      ]
    },
    {
      "step_id": "S5",
      "tool": "spatial_join",
      "purpose": "aggregate building GFA within parcels",
      "inputs": {
        "target_layer": "parcels_area",
        "join_layer": "buildings_gfa"
      },
      "parameters": {
        "match_option": "CONTAINS",
        "summary_fields": [
          {
            "field": "building_area",
            "statistic": "SUM",
            "output_field": "total_building_area"
          }
        ],
        "keep_all_target_features": true
      },
      "outputs": {
        "output_layer": "parcels_building_area",
        "geometry_type": "polygon"
      },
      "rationale": "Aggregate the building floor area contained within each land parcel and add it to the land parcel's attributes.",
      "preconditions": [
        {
          "type": "layer_exists",
          "layer": "buildings_gfa",
          "required": true
        }
      ],
      "postconditions": [
        {
          "type": "field_populated_rate",
          "layer": "parcels_building_area",
          "field": "total_building_area",
          "min_non_null_ratio": 0.8,
          "severity": "warning"
        }
      ]
    },
    {
      "step_id": "S6",
      "tool": "calculate_field",
      "purpose": "calculate parcel floor area ratio",
      "inputs": {
        "source_layer": "parcels_building_area"
      },
      "parameters": {
        "target_field": "floor_area_ratio",
        "expression_type": "python",
        "expression": "safe_divide(!total_building_area!, !parcel_area!)",
        "creates_field_if_missing": true
      },
      "outputs": {
        "output_layer": "parcels_far_ready",
        "geometry_type": "polygon"
      },
      "rationale": "Calculating the plot ratio provides an indicator for scoring the subsequent development potential.",
      "preconditions": [
        {
          "type": "fields_exist",
          "layer": "parcels_building_area",
          "fields": ["total_building_area", "parcel_area"],
          "required": true
        }
      ],
      "postconditions": [
        {
          "type": "field_populated_rate",
          "layer": "parcels_far_ready",
          "field": "floor_area_ratio",
          "min_non_null_ratio": 0.8,
          "severity": "warning"
        }
      ]
    },
    {
      "step_id": "S7",
      "tool": "spatial_join",
      "purpose": "select parcels within 500m of stations",
      "inputs": {
        "target_layer": "parcels_far_ready",
        "join_layer": "stations_buffer_500m"
      },
      "parameters": {
        "match_option": "INTERSECT",
        "keep_all_target_features": false
      },
      "outputs": {
        "output_layer": "parcels_in_500m",
        "geometry_type": "polygon"
      },
      "rationale": "Spatial join yields a set of land parcels affected by the site.",
      "preconditions": [
        {
          "type": "layer_exists",
          "layer": "stations_buffer_500m",
          "required": true
        }
      ],
      "postconditions": [
        {
          "type": "non_empty_output",
          "severity": "warning"
        }
      ]
    },
    {
      "step_id": "S8",
      "tool": "select_by_attribute",
      "purpose": "select residential parcels",
      "inputs": {
        "source_layer": "parcels_in_500m"
      },
      "parameters": {
        "where": "land_use IN ('residential','mixed_residential')"
      },
      "outputs": {
        "output_layer": "residential_candidates",
        "geometry_type": "polygon"
      },
      "rationale": "将候选集合限定为居住相关地块",
      "preconditions": [
        {
          "type": "field_exists",
          "layer": "parcels_in_500m",
          "field": "land_use",
          "required": true
        }
      ],
      "postconditions": [
        {
          "type": "non_empty_output",
          "severity": "warning"
        }
      ]
    },
    {
      "step_id": "S9",
      "tool": "calculate_field",
      "purpose": "计算或标准化更新潜力指标",
      "inputs": {
        "source_layer": "residential_candidates"
      },
      "parameters": {
        "target_field": "redevelopment_score",
        "expression_type": "python",
        "expression": "calc_score(!year_built!, !floor_area_ratio!)",
        "creates_field_if_missing": true
      },
      "outputs": {
        "output_layer": "residential_scored",
        "geometry_type": "polygon"
      },
      "rationale": "统一更新潜力指标，便于最终筛选",
      "preconditions": [
        {
          "type": "fields_exist_any",
          "layer": "residential_candidates",
          "fields": ["redevelopment_score", "year_built", "floor_area_ratio"],
          "required": true,
          "notes": "如果已有 redevelopment_score 则不需要 year_built 和 floor_area_ratio"
        }
      ],
      "postconditions": [
        {
          "type": "field_populated_rate",
          "layer": "residential_scored",
          "field": "redevelopment_score",
          "min_non_null_ratio": 0.8,
          "severity": "warning"
        }
      ]
    },
    {
      "step_id": "S10",
      "tool": "select_by_attribute",
      "purpose": "输出高潜力地块",
      "inputs": {
        "source_layer": "residential_scored"
      },
      "parameters": {
        "where": "redevelopment_score >= 0.7"
      },
      "outputs": {
        "output_layer": "renewal_priority_parcels",
        "geometry_type": "polygon"
      },
      "rationale": "按阈值筛选高潜力目标，供规划复核",
      "preconditions": [
        {
          "type": "field_exists",
          "layer": "residential_scored",
          "field": "redevelopment_score",
          "required": true
        }
      ],
      "postconditions": [
        {
          "type": "non_empty_output",
          "severity": "warning"
        }
      ]
    }
  ],
  "outputs": [
    {
      "name": "renewal_priority_parcels",
      "geometry_type": "polygon",
      "required_fields": ["parcel_id", "land_use", "redevelopment_score"],
      "optional_fields": ["station_id", "distance_to_station"],
      "deliverables": ["feature_layer", "summary_table"]
    }
  ],
  "quality_checks": [
    {
      "id": "QC1",
      "type": "crs_projected_for_distance_ops",
      "severity": "error",
      "applies_to_tools": ["buffer"]
    },
    {
      "id": "QC2",
      "type": "field_existence",
      "severity": "error",
      "notes": "where 子句里的字段必须存在"
    },
    {
      "id": "QC3",
      "type": "buffer_distance_reasonable_range",
      "severity": "warning",
      "rules": {
        "meters_min": 10,
        "meters_max": 20000
      }
    }
  ]
}
