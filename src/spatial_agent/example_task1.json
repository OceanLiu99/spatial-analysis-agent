{
    "workflow_name": "Count POIs within 150m of metro stations",
    "task_statement": "计算每个地铁站点周边150m范围内POI点的数量，并把数量写回站点图层字段 poi_count。",
    "arcgis_context": {
    "workspace": "project.gdb",
    "coordinate_system": "projected CRS recommended",
    "linear_unit": "meters",
    "area_unit": "square_meters"
},
"inputs": [
    {
        "layer_name": "metro_stations",
        "geometry_type": "point",
        "required_fields": ["station_id"],
        "optional_fields": ["station_name"],
        "notes": "station_id 必须唯一，作为 join key"
    },
    {
        "layer_name": "poi",
        "geometry_type": "point",
        "required_fields": ["poi_id", "poi_type"],
        "notes": "poi_id 建议唯一"
        }
],
"steps": [
    {
        "step_id": "S1",
        "tool": "Buffer",
        "purpose": "为每个地铁站点生成150m缓冲区，用于后续空间统计",
        "parameters": {
        "distance": 150,
        "unit": "meters",
        "dissolve_type": "NONE"
    },
    "inputs": [
        {
            "source": "input",
            "layer_name": "metro_stations"
        }
    ],
    "outputs": [
        {
            "name": "station_buffer_150m",
            "type": "feature_class",
            "geometry_type": "polygon",
            "new_fields": [],
            "path_hint": "project.gdb/station_buffer_150m"
        }
    ],
    "qc_checks": [
        {
            "check": "缓冲区数量应等于站点数量",
            "how": "比较站点条数与 station_buffer_150m 条数",
            "pass_condition": "count(station_buffer_150m) == count(metro_stations)"
        }
    ]
},
{
    "step_id": "S2",
    "tool": "SpatialJoin",
    "purpose": "统计每个缓冲区内的POI数量，并把统计结果带回缓冲区",
    "parameters": {
        "target_features": "S1.station_buffer_150m",
        "join_features": "poi",
        "join_operation": "JOIN_ONE_TO_ONE",
        "match_option": "CONTAINS",
        "summary_fields": [
            {
            "field": "poi_id",
            "statistic": "COUNT",
            "out_field": "poi_count"
            }
        ]
    },
    "inputs": [
        {
            "source": "step_output",
            "layer_name": "S1.station_buffer_150m"
        },
        {
            "source": "input",
            "layer_name": "poi"
        }
    ],
    "outputs": [
        {
            "name": "buffer_with_poi_count",
            "type": "feature_class",
            "geometry_type": "polygon",
            "new_fields": ["poi_count"],
            "path_hint": "project.gdb/buffer_with_poi_count"
        }
    ],
    "qc_checks": [
        {
            "check": "poi_count 不应为空",
            "how": "统计 poi_count 为 null 的记录数",
            "pass_condition": "null_count(poi_count) == 0"
        },
        {
            "check": "poi_count 应为非负整数",
            "how": "检查最小值与类型",
            "pass_condition": "min(poi_count) >= 0"
        }
    ]
},
{
    "step_id": "S3",
    "tool": "SpatialJoin",
    "purpose": "把 poi_count 写回站点点图层，每个站点对应一个数量",
    "parameters": {
        "target_features": "metro_stations",
        "join_features": "S2.buffer_with_poi_count",
        "join_operation": "JOIN_ONE_TO_ONE",
        "match_option": "WITHIN",
        "field_mapping": [
            {
                "from_field": "poi_count",
                "to_field": "poi_count",
                "rule": "FIRST"
            }
        ]
    },
    "inputs": [
        {
            "source": "input",
            "layer_name": "metro_stations"
        },
        {
            "source": "step_output",
            "layer_name": "S2.buffer_with_poi_count"
        }
    ],
    "outputs": [
        {
            "name": "stations_with_poi_count",
            "type": "feature_class",
            "geometry_type": "point",
            "new_fields": ["poi_count"],
            "path_hint": "project.gdb/stations_with_poi_count"
        }
    ],
    "qc_checks": [
        {
            "check": "输出站点数量应保持不变",
            "how": "比较 metro_stations 与 stations_with_poi_count 的条数",
            "pass_condition": "count(stations_with_poi_count) == count(metro_stations)"
        }
    ]
}
    ],
    "outputs": [
        {
            "name": "stations_with_poi_count",
            "type": "feature_class",
            "geometry_type": "point",
            "fields": ["station_id", "poi_count"],
            "description": "每个地铁站点附带150m范围内POI数量"
        }
    ],
    "assumptions": [
        "数据已处于投影坐标系，且单位为 meters。如果是地理坐标系，需先投影，否则150m不可靠。",
        "station_id 在 metro_stations 中唯一。"
    ]
}